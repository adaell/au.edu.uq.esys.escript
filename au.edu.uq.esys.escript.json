{
    "app-id": "au.edu.uq.esys.escript",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "24.08",
    "sdk": "org.freedesktop.Sdk",
    "command": "run-escript",
    "finish-args": [
        "--filesystem=home",
        "--share=network",
        "--share=ipc",
        "--device=dri",
        "--socket=fallback-x11",
        "--socket=wayland",
        "--env=PATH=/var/data/python/bin:/app/bin:/usr/bin"
    ],
    "modules": [
        "python3-modules.json",
        {
            "name": "proj",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DBUILD_TESTING=OFF"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/OSGeo/PROJ.git",
                    "tag": "9.4.1",
                    "commit": "875a485fa5ef435c57f7682f904dd31ca92253ab"
                }
            ]
        },
        {
            "name": "cython-pyproj",
            "buildsystem": "simple",
            "build-commands": [
                "pip3 install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} cython"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/7f/a2/fd5ced5dd33597ef291861bfadd46820de417b41bcb6ca2fa0b5f6fa8152/Cython-3.0.0.tar.gz",
                    "sha256": "350b18f9673e63101dbbfcf774ee2f57c20ac4636d255741d76ca79016b1bd82"
                }
            ]
        },
        {
            "name": "pyproj",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/pyproj4/pyproj.git",
                    "tag": "3.6.1",
                    "commit": "0c5159aab8c32488584ae472b3752203f1005559"
                }
            ]
        },
        {
            "name": "boost",
            "buildsystem": "simple",
            "build-commands": [
                "./bootstrap.sh --with-toolset=gcc --with-icu --with-python-version=3.12",
                "./b2 stage --prefix=\"${FLATPAK_DEST}\" --with-python --with-iostreams --with-random variant=release threading=multi link=shared toolset=gcc  debug-symbols=off",
                "./b2 install --prefix=\"${FLATPAK_DEST}\" --with-python --with-iostreams --with-random variant=release  threading=multi link=shared toolset=gcc debug-symbols=off"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/boost/boost/1.87.0/boost_1_87_0.tar.bz2",
                    "sha256": "af57be25cb4c4f4b413ed692fe378affb4352ea50fbe294a11ef548f4d527d89"
                }
            ]
        },
        {
            "name": "zlib",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/madler/zlib.git",
                    "tag": "v1.3.1",
                    "commit": "51b7f2abdade71cd9bb0e7a373ef2610ec6f9daf"
                }
            ]
        },
        {
            "name": "hdf5",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DCMAKE_C_FLAGS=\"-DH5_USE_110_API\"",
                "-DHDF5_ENABLE_Z_LIB_SUPPORT:BOOL=ON"
            ],
            "builddir": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.1/src/hdf5-1.12.1.tar.bz2",
                    "sha256": "aaf9f532b3eda83d3d3adc9f8b40a9b763152218fa45349c3bc77502ca1f8f1c"
                }
            ]
        },
        {
            "name": "netcdf-c",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/Unidata/netcdf-c/archive/refs/tags/v4.9.2.tar.gz",
                    "sha256": "bc104d101278c68b303359b3dc4192f81592ae8640f1aee486921138f7f88cb7"
                }
            ]
        },
        {
            "name": "netcdf-cxx",
            "sources": [
                {
                    "type": "archive",
                    "url":  "https://github.com/Unidata/netcdf-cxx4/archive/refs/tags/v4.3.1.tar.gz",
                    "sha256": "e3fe3d2ec06c1c2772555bf1208d220aab5fee186d04bd265219b0bc7a978edc"
                }
            ]
        },
        {
            "name": "gmsh",
            "buildsystem": "cmake",
            "config-opts": [
                "-DDEFAULT=0",
                "-DENABLE_BUILD_LIB=1",
                "-DENABLE_POST=1",
                "-DENABLE_PARSER=1"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://gmsh.info/src/gmsh-4.11.1-source.tgz",
                    "sha256": "c5fe1b7cbd403888a814929f2fd0f5d69e27600222a18c786db5b76e8005b365"
                }
            ]
        },
        {
            "name": "pip",
            "buildsystem": "simple",
            "build-commands": [
                "install -Dm755 pip.pyz -t /app/bin/"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://bootstrap.pypa.io/pip/pip.pyz",
                    "sha256": "c59df64b826d5baa978829fd1e1b3ea2e748f73dce7cce58d09aa28a1c9323a7"
                }
            ]
        },
        {
            "name": "trilinos",
            "buildsystem": "cmake-ninja",
            "config-opts": [
                "-DMPI_C_COMPILER='which mpicc'",
                "-DMPI_CXX_COMPILER='which mpic++'",
                "-DMPI_Fortran_COMPILER='which mpif90'",
                "-DTrilinos_ENABLE_CXX11=ON",
                "-DCMAKE_C_FLAGS=' -w -fopenmp'",
                "-DCMAKE_CXX_FLAGS=' -w -fopenmp'",
                "-DTrilinos_ENABLE_Fortran=ON",
                "-DBUILD_SHARED_LIBS=ON",
                "-DTPL_ENABLE_BLAS=ON",
                "-DTPL_ENABLE_Boost=ON",
                "-DTPL_ENABLE_Cholmod=ON",
                "-DTPL_ENABLE_LAPACK=ON",
                "-DTPL_ENABLE_METIS=ON",
                "-DTPL_ENABLE_SuperLU=OFF",
                "-DTPL_ENABLE_UMFPACK=ON",
                "-DTPL_ENABLE_PARMETIS=ON",
                "-DTPL_ENABLE_SCALAPACK=ON",
                "-DTPL_ENABLE_MUMPS=OFF",
                "-DTrilinos_ENABLE_Amesos=ON",
                "-DTrilinos_ENABLE_Amesos2=ON",
                "-DTrilinos_ENABLE_AztecOO=ON",
                "-DTrilinos_ENABLE_Belos=ON",
                "-DTrilinos_ENABLE_Ifpack=ON",
                "-DTrilinos_ENABLE_Ifpack2=ON",
                "-DTrilinos_ENABLE_Kokkos=ON",
                "-DTrilinos_ENABLE_Komplex=ON",
                "-DTrilinos_ENABLE_ML=ON",
                "-DTrilinos_ENABLE_MueLu=ON",
                "-DTrilinos_ENABLE_Teuchos=ON",
                "-DTrilinos_ENABLE_Tpetra=ON",
                "-DTrilinos_ENABLE_ALL_OPTIONAL_PACKAGES=ON",
                "-DKOKKOS_ENABLE_AGGRESSIVE_VECTORIZATION=ON",
                "-DTpetra_INST_COMPLEX_DOUBLE=ON",
                "-DTeuchos_ENABLE_COMPLEX=ON",
                "-DTpetra_INST_INT_INT=ON",
                "-DTpetra_ENABLE_DEPRECATED_CODE=ON",
                "-DTrilinos_ENABLE_OpenMP=ON",
                "-DTrilinos_ENABLE_MPI=ON",
                "-DTrilinos_ENABLE_EXPLICIT_INSTANTIATION=ON",
                "-DKOKKOS_ENABLE_COMPILER_WARNINGS=ON",
                "-DAmesos2_ENABLE_Basker=ON",
                "-DTpetra_INST_SERIAL:BOOL=ON",
                "-DTrilinos_ENABLE_TESTS=OFF"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/trilinos/Trilinos.git",
                    "tag": "trilinos-release-16-0-0",
                    "commit": "c6f6bea715046c00b327f5ddaacdc372dccd3f64"
                }
            ]
        },
        {
            "name": "escript",
            "buildsystem": "simple",
            "build-commands": [
                "ln -s /app/lib/python3.10/site-packages/numpy/core/include/numpy /app/include/",
                "ln -s /app/bin/pip.pyz /app/bin/pip",
                "scons options_file=scons/flatpak_options.py umfpack=0 trilinos=0 werror=0 silo=0 cxx_extra='-fPIC -Wno-psabi' -j`nproc --all`"
            ],
            "post-install" : [
                "install -Dm644 tools/flatpak/au.edu.uq.esys.escript.png /app/share/icons/hicolor/256x256/apps/au.edu.uq.esys.escript.png",
                "install -Dm644 tools/flatpak/au.edu.uq.esys.escript.desktop /app/share/applications/au.edu.uq.esys.escript.desktop",
                "install -Dm644 au.edu.uq.esys.escript.appdata.xml /app/share/appdata/au.edu.uq.esys.escript.appdata.xml"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/LutzGross/esys-escript.github.io.git",
                    "tag": "6.0.0",
                    "commit": "001bfeef67d69d460e36c32859e3e8edeee281c4"
                },
                {
                    "type": "patch",
                    "path": "flatpak_options.py.patch"
                },
                {
                    "type": "file",
                    "path": "au.edu.uq.esys.escript.appdata.xml"
                }
            ]
        }
    ]
}
